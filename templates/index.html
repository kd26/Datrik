<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Datrik - AI Data Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-bubble {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        .message-user {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
        }
        
        .message-assistant {
            background: rgba(255, 255, 255, 0.95);
            color: #1a202c;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-input {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }
        
        .chat-input:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #4a5568;
            box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
        }
        
        .send-button {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(74, 85, 104, 0.4);
        }
        
        .example-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .example-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .history-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }
        
        .history-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(4px);
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        /* Mobile-specific fixes */
        @media (max-width: 1024px) {
            .main-content {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
                position: relative;
                overflow: hidden;
            }
            
            .chat-input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                z-index: 20;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
            
            .welcome-area {
                padding-bottom: 140px; /* Ensure content doesn't hide behind fixed input */
            }
            
            #chat-messages-container {
                padding-bottom: 120px; /* Space for fixed input area */
                overflow-y: scroll;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                height: calc(100vh - 120px);
                height: calc(100dvh - 120px);
            }
            
            /* Fix body scrolling */
            body {
                overflow: hidden;
                height: 100vh;
                height: 100dvh;
            }
        }
    </style>
</head>
<body class="overflow-hidden lg:overflow-hidden">
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-80 glass-effect z-50 sidebar-transition transform -translate-x-full lg:translate-x-0">
        <div class="p-6 h-full flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-gray-600 to-gray-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-brain text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-white text-xl font-bold">Datrik</h1>
                    </div>
                </div>
                <button id="sidebar-close" class="lg:hidden text-white hover:text-opacity-70">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Database Stats -->
            <div class="mb-6">
                <h3 class="text-white text-lg font-semibold mb-3 flex items-center">
                    <i class="fas fa-database mr-2"></i>
                    Database Overview
                </h3>
                <div class="space-y-2" id="stats-container">
                    <!-- Stats will be loaded here -->
                </div>
                <div class="mt-3 p-2 rounded bg-white bg-opacity-10">
                    <p class="text-white text-xs font-medium">Data Range</p>
                    <p class="text-white text-opacity-70 text-xs">90 days of sample data</p>
                </div>
            </div>
            
            <!-- Chat History -->
            <div class="flex-1 min-h-0">
                <h3 class="text-white text-lg font-semibold mb-3 flex items-center">
                    <i class="fas fa-history mr-2"></i>
                    Chat History
                </h3>
                <div class="h-full overflow-y-auto scrollbar-thin" id="chat-history">
                    <!-- Chat history items will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="lg:ml-80 min-h-screen flex flex-col main-content">
        <!-- Top Bar -->
        <div class="glass-effect p-4 flex items-center justify-between">
            <button id="sidebar-toggle" class="lg:hidden text-white hover:text-opacity-70">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-white text-sm font-medium">AI Models Active</span>
                </div>
                <div class="hidden md:flex items-center space-x-2 text-white text-opacity-70 text-sm">
                    <i class="fas fa-clock"></i>
                    <span id="current-time"></span>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="flex-1 min-h-0 flex flex-col">
            <!-- Messages Container with full width scrolling -->
            <div class="flex-1 min-h-0 overflow-y-auto scrollbar-thin" id="chat-messages-container">
                <div class="px-6 py-6" id="chat-messages">
                        <!-- Welcome Message -->
                        <div class="flex justify-center py-12 welcome-area">
                            <div class="text-center max-w-4xl w-full">
                                <div class="w-16 h-16 bg-gradient-to-r from-gray-600 to-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-chart-line text-white text-2xl"></i>
                                </div>
                                <h2 class="text-white text-2xl font-bold mb-2">Welcome to Datrik</h2>
                                <p class="text-white text-opacity-70 mb-8 max-w-md mx-auto text-center">
                                    Your AI-powered analyst. Ask me anything about your data and get instant insights.
                                </p>
                                
                                <!-- Quick Examples -->
                                <div class="max-w-2xl mx-auto">
                                    <h3 class="text-white text-sm font-medium mb-4 flex items-center justify-center">
                                        <i class="fas fa-lightbulb mr-2"></i>
                                        Quick Examples
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <button class="example-button p-3 rounded-lg text-white text-sm">
                                            Top performers by volume
                                        </button>
                                        <button class="example-button p-3 rounded-lg text-white text-sm">
                                            Category analysis
                                        </button>
                                        <button class="example-button p-3 rounded-lg text-white text-sm">
                                            Weekly trends
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="px-6 pb-6 chat-input-area">
                <div class="max-w-4xl mx-auto">
                    <div class="glass-effect rounded-2xl p-4">
                        <form id="query-form" class="flex items-center space-x-4">
                        <div class="flex-1">
                            <textarea 
                                id="question-input" 
                                placeholder="Ask me anything about your data..." 
                                class="chat-input w-full px-4 py-3 rounded-xl border-0 outline-none resize-none"
                                rows="1"
                                required
                            ></textarea>
                        </div>
                        <button 
                            type="submit" 
                            class="send-button w-12 h-12 rounded-xl flex items-center justify-center text-white outline-none flex-shrink-0"
                            id="submit-btn"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const chatMessages = document.getElementById('chat-messages');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const queryForm = document.getElementById('query-form');
        const questionInput = document.getElementById('question-input');
        const submitBtn = document.getElementById('submit-btn');
        const statsContainer = document.getElementById('stats-container');
        const chatHistory = document.getElementById('chat-history');
        
        // Sidebar functionality
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        // Chat history storage
        let conversationHistory = JSON.parse(localStorage.getItem('datrik-chat-history') || '[]');
        
        // Session management for LangChain memory
        let currentSessionId = localStorage.getItem('datrik-current-session') || null;
        let userIdentifier = 'user-' + Date.now(); // Simple user identification
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadChatHistory();
            updateTime();
            setInterval(updateTime, 1000);
            
            // Initialize or create session
            initializeSession();
            
            // Auto-resize textarea
            questionInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
            
            // Enter to send, Shift+Enter for new line
            questionInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    queryForm.dispatchEvent(new Event('submit'));
                }
            });
        });
        
        // Sidebar controls
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        });
        
        sidebarClose.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        
        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }
        
        // Example button handlers
        document.querySelectorAll('.example-button').forEach(btn => {
            btn.addEventListener('click', () => {
                questionInput.value = btn.textContent.trim();
                questionInput.focus();
                closeSidebar();
            });
        });
        
        // Form submission
        queryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = questionInput.value.trim();
            if (!question) return;
            
            // Add to history
            addToHistory(question);
            
            // Add user message
            addMessage('user', question);
            
            // Show typing indicator
            const typingId = addMessage('assistant', '', true);
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        session_id: currentSessionId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Remove typing indicator
                    document.getElementById(typingId).remove();
                    
                    // Update session ID if provided
                    if (data.session_id) {
                        currentSessionId = data.session_id;
                        localStorage.setItem('datrik-current-session', currentSessionId);
                    }
                    
                    // Add conversational analysis
                    addConversationalMessage(data);
                } else {
                    document.getElementById(typingId).remove();
                    addMessage('assistant', `❌ Error: ${data.error}`);
                }
            } catch (error) {
                document.getElementById(typingId).remove();
                addMessage('assistant', `❌ Error: ${error.message}`);
            }
            
            // Reset form
            questionInput.value = '';
            questionInput.style.height = 'auto';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        });
        
        function addConversationalMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-bubble mb-6 px-6 flex justify-start';
            
            const bubble = document.createElement('div');
            bubble.className = 'max-w-4xl w-full p-4 rounded-2xl message-assistant';
            
            // Use AI-generated analysis directly
            let conversationalText = data.analysis || "I couldn't find any data matching your query. Try asking about something else!";
            
            bubble.innerHTML = `
                <div class="mb-4">${conversationalText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>
                
                ${data.data && data.data.length > 0 ? `
                <div class="border-t pt-4 mt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-700">Data Results (${data.row_count} records)</h4>
                        <div class="flex space-x-2">
                            <button data-sql-query="${encodeURIComponent(data.sql_query)}" data-provider="${data.provider}" class="view-query-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs">
                                <i class="fas fa-code mr-1"></i> View Query
                            </button>
                            <button onclick="downloadData(${JSON.stringify(data.data).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-white rounded text-xs">
                                <i class="fas fa-download mr-1"></i> Download
                            </button>
                        </div>
                    </div>
                    <div id="data-table-${Date.now()}" class="max-h-64 overflow-y-auto">
                        ${generateDataTable(data.data)}
                    </div>
                </div>
                ` : ''}
            `;
            
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        
        function addMessage(role, content, isTyping = false) {
            const messageId = 'msg-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-bubble mb-6 px-6 flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-4xl w-full p-4 rounded-2xl ${
                role === 'user' 
                    ? 'message-user' 
                    : 'message-assistant'
            } ${isTyping ? 'typing-indicator' : ''}`;
            
            if (isTyping) {
                bubble.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span class="text-gray-500 text-sm">Thinking...</span>
                    </div>
                `;
            } else {
                // Handle markdown-like formatting
                const formattedContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/```sql\n([\s\S]*?)\n```/g, '<pre class="bg-gray-800 text-green-400 p-3 rounded-lg mt-2 text-sm overflow-x-auto"><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code class="bg-gray-200 px-1 py-0.5 rounded text-sm">$1</code>')
                    .replace(/\n/g, '<br>');
                
                bubble.innerHTML = formattedContent;
            }
            
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            return messageId;
        }
        
        function addDataTable(data) {
            if (!data || data.length === 0) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-bubble mb-6 flex justify-start';
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'max-w-4xl message-assistant rounded-2xl overflow-hidden';
            
            const table = document.createElement('table');
            table.className = 'w-full text-sm';
            
            // Headers
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const headerRow = document.createElement('tr');
            
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left font-semibold text-gray-700';
                th.textContent = key.replace(/_/g, ' ').toUpperCase();
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Body
            const tbody = document.createElement('tbody');
            data.slice(0, 10).forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 text-gray-800';
                    td.textContent = value;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            
            if (data.length > 10) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'p-3 text-center text-gray-500 text-sm bg-gray-50 border-t';
                moreDiv.textContent = `... and ${data.length - 10} more records`;
                tableContainer.appendChild(moreDiv);
            }
            
            messageDiv.appendChild(tableContainer);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addToHistory(question) {
            const historyItem = {
                id: Date.now(),
                question: question,
                timestamp: new Date().toLocaleString()
            };
            
            conversationHistory.unshift(historyItem);
            conversationHistory = conversationHistory.slice(0, 20); // Keep last 20
            
            localStorage.setItem('datrik-chat-history', JSON.stringify(conversationHistory));
            loadChatHistory();
        }
        
        function loadChatHistory() {
            chatHistory.innerHTML = '';
            
            if (conversationHistory.length === 0) {
                chatHistory.innerHTML = `
                    <div class="text-center text-white text-opacity-50 text-sm py-8">
                        <i class="fas fa-comment-alt text-2xl mb-2"></i>
                        <p>No chat history yet</p>
                    </div>
                `;
                return;
            }
            
            conversationHistory.forEach(item => {
                const historyDiv = document.createElement('div');
                historyDiv.className = 'history-item p-3 rounded-lg mb-2 cursor-pointer';
                historyDiv.innerHTML = `
                    <p class="text-white text-sm font-medium truncate">${item.question}</p>
                    <p class="text-white text-opacity-50 text-xs mt-1">${item.timestamp}</p>
                `;
                
                historyDiv.addEventListener('click', () => {
                    questionInput.value = item.question;
                    questionInput.focus();
                    closeSidebar();
                });
                
                chatHistory.appendChild(historyDiv);
            });
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const statItems = [
                    { label: 'Users', value: stats.users || 0, icon: 'fas fa-users', color: 'from-gray-500 to-gray-700' },
                    { label: 'Restaurants', value: stats.restaurants || 0, icon: 'fas fa-store', color: 'from-gray-600 to-gray-800' },
                    { label: 'Orders', value: stats.orders || 0, icon: 'fas fa-shopping-cart', color: 'from-gray-500 to-gray-700' },
                    { label: 'Reviews', value: stats.reviews || 0, icon: 'fas fa-star', color: 'from-gray-600 to-gray-800' },
                ];
                
                statsContainer.innerHTML = statItems.map(item => `
                    <div class="stat-item p-2 rounded flex items-center justify-between">
                        <div>
                            <p class="text-white text-xs font-medium">${item.label}</p>
                            <p class="text-white text-sm font-bold">${item.value.toLocaleString()}</p>
                        </div>
                        <div class="w-6 h-6 bg-gradient-to-r ${item.color} rounded flex items-center justify-center">
                            <i class="${item.icon} text-white text-xs"></i>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
        
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSidebar();
            }
        });
        
        function generateDataTable(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const rows = data.slice(0, 10); // Show first 10 rows
            
            return `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            ${headers.map(header => `<th class="px-4 py-2 text-left font-semibold text-gray-700">${header.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map((row, index) => `
                            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                ${headers.map(header => `<td class="px-4 py-2 text-gray-800">${row[header] || ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${data.length > 10 ? `<div class="p-2 text-center text-gray-500 text-xs bg-gray-50 border-t">... and ${data.length - 10} more records</div>` : ''}
            `;
        }
        
        window.viewQuery = function(query, provider) {
            const queryModal = document.createElement('div');
            queryModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            // Escape HTML in query for safe display
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            queryModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] overflow-y-auto shadow-2xl">
                    <div class="p-4 border-b flex items-center justify-between bg-gray-50">
                        <h3 class="font-semibold text-gray-800">Generated SQL Query (${escapeHtml(provider)})</h3>
                        <button class="close-modal-btn text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-200">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto whitespace-pre-wrap"><code>${escapeHtml(query)}</code></pre>
                        <div class="mt-4 flex justify-end">
                            <button class="copy-query-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-copy mr-2"></i>Copy Query
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(queryModal);
            
            // Close modal event listeners
            queryModal.addEventListener('click', (e) => {
                if (e.target === queryModal || e.target.closest('.close-modal-btn')) {
                    queryModal.remove();
                }
            });
            
            // Copy query functionality
            queryModal.querySelector('.copy-query-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(query).then(() => {
                    const btn = queryModal.querySelector('.copy-query-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = query;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    const btn = queryModal.querySelector('.copy-query-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                });
            });
        };
        
        window.downloadData = function(data) {
            if (!data || data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `datrik-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        };
        
        async function initializeSession() {
            if (!currentSessionId) {
                try {
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            user_identifier: userIdentifier
                        })
                    });
                    
                    const data = await response.json();
                    if (response.ok && data.session_id) {
                        currentSessionId = data.session_id;
                        localStorage.setItem('datrik-current-session', currentSessionId);
                        console.log('New session created:', currentSessionId);
                    }
                } catch (error) {
                    console.error('Failed to create session:', error);
                }
            } else {
                console.log('Using existing session:', currentSessionId);
            }
        }
        
        // Start new conversation (clear memory)
        window.startNewConversation = async function() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        user_identifier: userIdentifier
                    })
                });
                
                const data = await response.json();
                if (response.ok && data.session_id) {
                    currentSessionId = data.session_id;
                    localStorage.setItem('datrik-current-session', currentSessionId);
                    
                    // Clear chat messages
                    chatMessages.innerHTML = '';
                    
                    console.log('New conversation started:', currentSessionId);
                }
            } catch (error) {
                console.error('Failed to start new conversation:', error);
            }
        };
        
        // Clear history function (can be called from console)
        window.clearHistory = function() {
            localStorage.removeItem('datrik-chat-history');
            conversationHistory = [];
            loadChatHistory();
        };
        
        // Event delegation for dynamically created view query buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.view-query-btn')) {
                const button = e.target.closest('.view-query-btn');
                const encodedQuery = button.getAttribute('data-sql-query');
                const provider = button.getAttribute('data-provider');
                
                if (encodedQuery && provider) {
                    const decodedQuery = decodeURIComponent(encodedQuery);
                    viewQuery(decodedQuery, provider);
                }
            }
        });
    </script>
</body>
</html>